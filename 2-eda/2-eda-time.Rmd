---
title: "Chapter 12 Figures Over Time"
author: Robert Dinterman
date: "`r format(Sys.Date(), '%Y-%B-%d')`"
output:
  md_document:
    variant: markdown_github
---

```{r start, include = FALSE}
library("knitr")
library("lubridate")
library("scales")
library("tidyverse")

# Read in farms, use current year for future...
farms <- read_csv("../0-data/nass/operations.csv") %>% 
  bind_rows(data.frame(YEAR = max(.$YEAR) + 1)) %>% 
  fill(FARMS)

hist_data  <- read_csv("../0-data/uscourts/historical_ers_bankruptcies.csv") %>% 
  rename_all(toupper) %>% 
  left_join(farms)

month_data <- read_rds("../0-data/uscourts/f2_one/f2_one.rds") %>% 
  left_join(farms)
qtrly_data <- read_rds("../0-data/uscourts/f2_three/f2_three.rds") %>% 
  mutate(quarter = quarter(DATE)) %>% 
  left_join(farms)


```

```{r global_options, include=FALSE}
opts_chunk$set(cache = TRUE, echo = FALSE, warning = FALSE,
               message = FALSE, out.height = "100%", out.width = "100%")
```

# General Figures of Interest

## Individual Series

```{r national-annual}
annual_nat <- qtrly_data %>% 
  filter(!is.na(impute)) %>% 
  group_by(YEAR) %>% 
  summarise(CHAP_12_nat = sum(impute, na.rm = T),
            farms = mean(FARMS, na.rm = T),
            DATE = as.Date(paste0(mean(YEAR), "-12-31")))

ggplot(annual_nat, aes(YEAR, CHAP_12_nat)) +
  geom_line() +
  labs(x = "", y = "",
       title = "Annual Chapter 12 Filings",
       caption = "source: US Courts, Robert Dinterman") +
  scale_y_continuous(label = comma) +
  expand_limits(y = 0) +
  theme_minimal()

ggplot(annual_nat, aes(YEAR, 10000*CHAP_12_nat / farms)) +
  geom_line() +
  labs(x = "", y = "",
       title = "Annual Chapter 12 Filing Rate",
       subtitle = "per 10,000 farms",
       caption = "source: US Courts, Robert Dinterman") +
  scale_y_continuous(label = comma) +
  expand_limits(y = 0) +
  theme_minimal()

```

```{r national-quarter}
quarter_nat <- qtrly_data %>% 
  filter(!is.na(impute)) %>% 
  group_by(DATE) %>% 
  summarise(CHAP_12_qtr = sum(impute, na.rm = T),
            farms = mean(FARMS, na.rm = T))

ggplot(quarter_nat, aes(DATE, CHAP_12_qtr)) +
  geom_line() +
  labs(x = "", y = "",
       title = "Quarterly Chapter 12 Filings",
       caption = "source: US Courts, Robert Dinterman") +
  scale_y_continuous(label = comma) +
  expand_limits(y = 0) +
  theme_minimal()

ggplot(quarter_nat, aes(DATE, 40000*CHAP_12_qtr / farms)) +
  geom_line() +
  labs(x = "", y = "",
       title = "Quarterly Chapter 12 Filing Rate",
       subtitle = "annualized per 10,000 farms",
       caption = "source: US Courts, Robert Dinterman") +
  scale_y_continuous(label = comma) +
  expand_limits(y = 0) +
  theme_minimal()
```

```{r qtrly-bapcpa}
qtrly_data %>% 
  filter(DATE > "2005-10-17") %>% 
  group_by(DATE) %>% 
  summarise(CHAP_12 = sum(impute, na.rm = T),
            Quarter = factor(mean(quarter), levels = c(1, 2, 3, 4))) %>% 
  ggplot(aes(DATE, CHAP_12)) +
  geom_line(aes(group = Quarter, color = Quarter, linetype = Quarter)) +
  # geom_point(data = . %>% filter(qtr == 2)) +
  geom_point(aes(color = Quarter, shape = Quarter)) +
  theme_minimal() +
  scale_x_date(date_labels = "%Y",
               limits = as.Date(c("2005-01-01", "2020-01-01"))) +
  # scale_y_continuous(limits = c(0, 225)) +
  scale_color_viridis_d() +
  theme(legend.position = c(0.15, 0.8)) + 
  labs(x = "", y = "", shape = "Quarter", linetype = "Quarter",
       title = "National Chapter 12 Filings")
```

```{r national-monthly}
month_nat <- month_data %>% 
  group_by(DATE) %>% 
  summarise(CHAP_12_mth = sum(CHAP_12, na.rm = T),
            farms = mean(FARMS, na.rm = T))

ggplot(month_nat, aes(DATE, CHAP_12_mth)) +
  geom_line() +
  labs(x = "", y = "",
       title = "Monthly Chapter 12 Filings",
       caption = "source: US Courts, Robert Dinterman") +
  expand_limits(y = 0) +
  theme_minimal()

ggplot(month_nat, aes(DATE, 120000*CHAP_12_mth / farms)) +
  geom_line() +
  labs(x = "", y = "",
       title = "Monthly Chapter 12 Filing Rate",
       subtitle = "annualized per 10,000 farms",
       caption = "source: US Courts, Robert Dinterman") +
  expand_limits(y = 0) +
  theme_minimal()
```


<!-- ## Combined Series -->

<!-- ```{r national-annual-quarterly} -->
<!-- annual_qtr <- quarter_nat %>%  -->
<!--   left_join(annual_nat) %>%  -->
<!--   mutate(year = year(DATE)) %>%  -->
<!--   fill(CHAP_12_nat, .direction = "up") -->

<!-- ``` -->









